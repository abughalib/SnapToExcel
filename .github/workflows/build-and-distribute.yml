name: Build & Distribute SnapToExcel

# Trigger on pushes to main (and also allow manual dispatch)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-package:
    # Build on both Ubuntu and Windows runners
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest ]
        python-version: [ 3.13 ]  # Ensure Python 3.13+

    steps:
      # 1. Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up the requested Python version
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Install system dependencies (Linux only)
      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y python3-dev python3-pip build-essential libgtk-3-dev python3-tk

      # 4. Install project dependencies
      #    On Linux: install both requirements.txt and requirements.linux.txt
      #    On Windows: install only requirements.txt.
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            pip install -r requirements.linux.txt
          fi

      # 5. Run the Cx_Freeze build to produce a standalone executable.
      - name: Build executable with Cx_Freeze
        shell: bash
        run: |
          python cxfreeze.py build

      # 6. Upload the entire "build/" directory as an artifact.
      #    The runner creates something like build/exe.win-*/ or build/exe.linux-*/ depending on OS.
      - name: Upload built artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SnapToExcel-${{ matrix.os }}
          path: build/

      # 7. Create GitHub Release on push to main
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: |
            build/**/*
          draft: false
          prerelease: false
